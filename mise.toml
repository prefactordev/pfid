[tools]
erlang = "28.3"
elixir = "1.19.4-otp-28"
node = "24"
pnpm = "10"
python = "3.13"

[env]
ERL_AFLAGS="-kernel shell_history enabled"

# Top-level aggregate tasks
[tasks.deps]
description = "Install dependencies for all codebases"
depends = ["elixir:deps", "typescript:deps", "python:deps"]

[tasks.test]
description = "Run tests for all codebases"
depends = ["elixir:test", "typescript:test", "python:test"]

[tasks.typecheck]
description = "Run type checking for all codebases"
depends = ["typescript:typecheck", "python:typecheck"]

[tasks.build]
description = "Build all codebases"
depends = ["elixir:compile", "typescript:build"]

[tasks.check]
description = "Run all checks (tests, typecheck, lint, build)"
depends = ["test", "typecheck", "python:lint", "build"]

# Elixir tasks
[tasks."elixir:test"]
run = 'cd elixir && mix test'

[tasks."elixir:console"]
run = 'cd elixir && iex -S mix'

[tasks."elixir:deps"]
run = 'cd elixir && mix deps.get'

[tasks."elixir:format"]
run = 'cd elixir && mix format'

[tasks."elixir:compile"]
run = 'cd elixir && mix compile'

[tasks."regenerate_fixtures"]
run = 'cd elixir && mix generate_fixtures ../fixtures/pfid_fixtures.csv'

[tasks."typescript:deps"]
run = 'cd typescript && pnpm install'

[tasks."typescript:test"]
run = 'cd typescript && pnpm test'

[tasks."typescript:build"]
run = 'cd typescript && pnpm run build'

[tasks."typescript:typecheck"]
run = 'cd typescript && pnpm run typecheck'

[tasks."python:deps"]
run = 'cd python && pip install -e ".[dev]"'

[tasks."python:test"]
run = 'cd python && pytest'

[tasks."python:typecheck"]
run = 'cd python && mypy src/pfid'

[tasks."python:lint"]
run = 'cd python && ruff check src/pfid tests'

[tasks."typescript:publish"]
description = "Publish typescript package to npm (fetches OTP from 1Password)"
depends = ["typescript:test", "typescript:typecheck", "typescript:build"]
run = 'cd typescript && pnpm publish --otp=$(op item get npmjs.com --otp)'

[tasks."python:build"]
description = "Build Python package"
run = 'cd python && python -m build'

[tasks."python:publish"]
description = "Publish Python package to PyPI (fetches OTP from 1Password)"
depends = ["python:test", "python:typecheck", "python:build"]
run = 'cd python && twine upload dist/* --username __token__ --password $(op item get pypi.org --field token)'
